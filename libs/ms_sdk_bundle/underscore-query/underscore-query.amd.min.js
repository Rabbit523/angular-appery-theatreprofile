define(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B={}.hasOwnProperty;t=this,A={},d=function(a){var b,c,d,e;for(e=["every","some","filter","first","find","reject","reduce","property","sortBy","indexOf","intersection","isEqual","keys","isArray","result","map","includes","isNaN"],b=0,d=e.length;b<d;b++)if(c=e[b],A[c]=a[c],!A[c])throw new Error(c+" missing. Please ensure that you first initialize underscore-query with either lodash or underscore")},A.getType=function(a){var b;return b=Object.prototype.toString.call(a).substr(8),b.substr(0,b.length-1)},A.makeObj=function(a,b){var c;return(c={})[a]=b,c},A.reverseString=function(a){return a.toLowerCase().split("").reverse().join("")},A.compoundKeys=["$and","$not","$or","$nor"],A.expectedArrayQueries=["$and","$or","$nor"],j=function(a,b){var c,d,e,f,g,h;for(g=b,d=c=0,f=a.length;c<f;d=++c)if(e=a[d],A.isArray(g))h=a.slice(d),g=A.map(g,function(a){return j(h,a)});else{if(!g)break;g=A.result(g,e)}return g},A.makeGetter=function(a){return a=a.split("."),function(b){return j(a,b)}},l=function(a,b){var c,d,e;c=[];for(d in b)e=b[d],c.push(A.makeObj(a,A.makeObj(d,e)));return c},n=function(a){var b,c,d,e,f,g,h,i;f=[];for(b in a)if(B.call(a,b)){switch(e=a[b],c={key:b},(null!=e?e.$boost:void 0)&&(c.boost=e.$boost,delete e.$boost),b.indexOf(".")!==-1&&(c.getter=A.makeGetter(b)),d=A.getType(e)){case"RegExp":case"Date":c.type="$"+d.toLowerCase(),c.value=e;break;case"Array":A.includes(A.compoundKeys,b)?(c.type=b,c.value=p(e,b),c.key=null):(c.type="$eq",c.value=e);break;case"Object":if(g=A.keys(e).length,A.includes(A.compoundKeys,b))c.type=b,c.value=p(e,b),c.key=null;else if(1===g||2===g&&"$options"in e){for(h in e)if(B.call(e,h)){if(i=e[h],"$options"===h){if("$regex"in e||"regexp"in e)continue;throw new Error("$options needs a $regex")}if(!z(h,i))throw new Error("Query value ("+i+") doesn't match query type: ("+h+")");switch(c.type=h,h){case"$elemMatch":c.value=w(o(i));break;case"$endsWith":c.value=A.reverseString(i);break;case"$likeI":case"$startsWith":c.value=i.toLowerCase();break;case"$regex":case"$regexp":"string"==typeof i?c.value=new RegExp(i,e.$options||""):c.value=i;break;case"$not":case"$nor":case"$or":case"$and":c.value=p(A.makeObj(c.key,i)),c.key=null;break;case"$computed":c=A.first(n(A.makeObj(b,i))),c.getter=A.makeGetter(b);break;default:c.value=i}}}else c.type="$and",c.value=p(l(b,e)),c.key=null;break;default:c.type="$eq",c.value=e}"$eq"===c.type&&A.includes(["Object","Array"],d)?c.type="$deepEqual":A.isNaN(c.value)&&(c.type="$deepEqual"),f.push(c)}return f},x=["$lt","$lte","$gt","$gte","$exists","$has","$type","$ne","$eq","$mod","$size","$between","$betweene","$startsWith","$endsWith","$like","$likeI","$contains","$in","$nin","$all","$any","$none","$cb","$regex","$regexp","$deepEqual","$elemMatch","$not","$and","$or","$nor"],p=function(a,b){var c,d,e,f,g;return e=A.isArray(a)?a:function(){var b;b=[];for(d in a)B.call(a,d)&&(g=a[d],b.push(A.makeObj(d,g)));return b}(),c=function(a,c){var d;return d=n(c),"$or"===b&&d.length>=2?(a.push({type:"$and",parsedQuery:d}),a):a.concat(d)},f=A.reduce(e,c,[]),A.sortBy(f,function(a){var b;return b=A.indexOf(x,a.type),b>=0?b:1/0})},z=function(a,b){var c;switch(c=A.getType(b),a){case"$in":case"$nin":case"$all":case"$any":case"$none":return"Array"===c;case"$size":return"Number"===c;case"$regex":case"$regexp":return A.includes(["RegExp","String"],c);case"$like":case"$likeI":return"String"===c;case"$between":case"$mod":return"Array"===c&&2===b.length;case"$cb":return"Function"===c;default:return!0}},y=function(a,b){var c;switch(c=A.getType(b),a){case"$like":case"$likeI":case"$regex":case"$startsWith":case"$endsWith":return"String"===c;case"$contains":case"$all":case"$any":case"$elemMatch":return"Array"===c;case"$size":return A.includes(["String","Array"],c);case"$in":case"$nin":return null!=b;default:return!0}},q=function(a,b,c,d,e){switch(a){case"$and":case"$or":case"$nor":case"$not":return r(a,b,e,d);case"$cb":return b.call(d,c);case"$elemMatch":return u(c,b,null,!0)}switch("function"==typeof b&&(b=b()),a){case"$eq":return A.isArray(c)?A.includes(c,b):c===b;case"$deepEqual":return A.isEqual(c,b);case"$ne":return c!==b;case"$type":return typeof c===b;case"$lt":return null!=b&&c<b;case"$gt":return null!=b&&c>b;case"$lte":return null!=b&&c<=b;case"$gte":return null!=b&&c>=b;case"$between":return null!=b[0]&&null!=b[1]&&b[0]<c&&c<b[1];case"$betweene":return null!=b[0]&&null!=b[1]&&b[0]<=c&&c<=b[1];case"$size":return c.length===b;case"$exists":case"$has":return null!=c===b;case"$contains":return A.includes(c,b);case"$in":return A.includes(b,c);case"$nin":return!A.includes(b,c);case"$all":return A.every(b,function(a){return A.includes(c,a)});case"$any":return A.some(c,function(a){return A.includes(b,a)});case"$none":return!A.some(c,function(a){return A.includes(b,a)});case"$like":return c.indexOf(b)!==-1;case"$likeI":return c.toLowerCase().indexOf(b)!==-1;case"$startsWith":return 0===c.toLowerCase().indexOf(b);case"$endsWith":return 0===A.reverseString(c).indexOf(b);case"$regex":case"$regexp":return b.test(c);case"$mod":return c%b[0]===b[1];default:return!1}},w=function(a,b,c){var d;if(b&&(b=m(b)),c){if(1!==a.length)throw new Error("score operations currently don't work on compound queries");if(d=a[0],"$and"!==d.type)throw new Error("score operations only work on $and queries (not "+d.type);return function(a){return a._score=r(d.type,d.parsedQuery,b,a,!0),a}}return function(e){var f,g;for(f=0,g=a.length;f<g;f++)if(d=a[f],!r(d.type,d.parsedQuery,b,e,c))return!1;return!0}},r=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o;for(j=0,m=0,n=1/b.length,h=0,i=b.length;h<i;h++)switch(k=b[h],f=c?c(d,k.key):k.getter?k.getter(d,k.key):d[k.key],o=y(k.type,f),o&&(o=k.parsedQuery?w([k],c,e)(d):q(k.type,k.value,f,d,c)),o&&(j++,e&&(g=null!=(l=k.boost)?l:1,m+=n*g)),a){case"$and":if(!e&&!o)return!1;break;case"$not":if(o)return!1;break;case"$or":if(o)return!0;break;case"$nor":if(o)return!1;break;default:throw new Error("Invalid compound method")}return e?m:"$not"===a?0===j:"$or"!==a},o=function(a){var b,c,d,e,f,g,h,i,j,k;if(h=A.keys(a),!h.length)return[];for(b=A.intersection(A.compoundKeys,h),c=0,f=b.length;c<f;c++)if(j=b[c],!A.isArray(a[j])&&A.includes(A.expectedArrayQueries,j))throw new Error(j+" query must be an array");if(0===b.length)return[{type:"$and",parsedQuery:p(a)}];if(b.length!==h.length){A.includes(b,"$and")||(a.$and={},b.unshift("$and"));for(e in a)B.call(a,e)&&(k=a[e],A.includes(A.compundKeys,e)||(a.$and[e]=k,delete a[e]))}for(i=[],d=0,g=b.length;d<g;d++)j=b[d],i.push({type:j,parsedQuery:p(a[j],j)});return i},m=function(a){return"string"==typeof a?function(b,c){return b[a](c)}:a},a=function(){function a(a,b){this.items=a,this._getter=b,this.theQuery={}}return a.prototype.all=function(a,b){return a&&(this.items=a),a=this.indexes?this.getIndexedItems(this.items):this.items,u(a,this.theQuery,this._getter,b)},a.prototype.chain=function(){return _.chain(this.all.apply(this,arguments))},a.prototype.tester=function(){return k(this.theQuery,this._getter)},a.prototype.first=function(a){return this.all(a,!0)},a.prototype.getter=function(a){return this._getter=a,this},a}(),b=function(a){return function(b,c){var d;return c&&(b=A.makeObj(b,c)),null==(d=this.theQuery)[a]&&(d[a]=[]),this.theQuery[a].push(b),this}},s=A.compoundKeys;for(g=0,i=s.length;g<i;g++)h=s[g],a.prototype[h.substr(1)]=b(h);return a.prototype.find=a.prototype.query=a.prototype.run=a.prototype.all,c=function(b,c){return new a(b,c)},k=function(a,b){return w(o(a),m(b))},f=function(a,b,c){return u(a,b,c,!0)},u=function(a,b,d,e,f){var g;return arguments.length<2?c.apply(this,arguments):(d&&(d=m(d)),"Function"!==A.getType(b)&&(b=w(o(b),d,f)),(g=f?A.map:e?A.find:A.filter)(a,b))},v=function(a,b,c){return u(a,b,c,!1,!0)},u.build=c,u.parse=o,u.findOne=u.first=f,u.score=v,u.tester=u.testWith=k,u.getter=u.pluckWith=A.makeGetter,e=function(a,b){return null==b&&(b=!0),d(a),b&&a.mixin({query:u,q:u}),u},t._?e(t._):e});